<!DOCTYPE html>
<html lang="en">
<html>
<head>

	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>QDAcity API Test</title>
     <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
       
     
    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="css/landing-page.css" rel="stylesheet">
    <link href="css/footer.css" rel="stylesheet">
  
    

    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    
    <!-- EasyTree -->
	<link rel="stylesheet" type="text/css" href="EasyTree/skin-win8/ui.easytree.css">
	<script type="text/javascript" src="EasyTree/jquery.easytree.js"></script>
	
    <script type="text/javascript" src="js/loading/loadingoverlay.min.js"></script>
   <script type="text/javascript" src="js/DataTables-1.10.7/media/js/jquery.dataTables.min.js"></script>
    
    <script type="text/javascript" src="js/Squire/squire-raw.js"></script>
    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
    
    <link href="js/DataTables-1.10.7/media/css/jquery.dataTables.css" rel="stylesheet"> <!-- FIXME move to css folder -->
      
      
        <style>
    .validateTips { border: 1px solid transparent; padding: 0.3em; }
  </style>
  <style>
  iframe {
    border: 1px solid #888;
    width: 100%;
    height: 100px;
  }

/* .col-md-10
{
    background-color: green;
    overflow: auto;
    height: 90vh;
} */
  </style>
  
    <script type="text/javascript">
        function saveEditorContent() {
			var docIDs = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	var docTitles = $('#documentlist .ui-selected').map(function() {
                return $(this).text();
                
            });
        	changeDocumentData(docIDs[0], docTitles[0]);
		}
    </script>
    
    <script type="text/javascript" language="javascript" class="init">


var dataSet = [];

$(document).ready(function() {
	$('#codingtable').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="example"></table>' );

	var table = $('#example').dataTable( {
		"iDisplayLength": 7,
		"bLengthChange": false,
		"data": dataSet,
		"autoWidth": false,
		"columnDefs": [
		               { "width": "5%"},
		               { "width": "20%"},
		               { "width": "20%"}
		             ],
		"columns": [
			{  "title": "ID" , "width": "5%",},
			{ "title": "Document", "width": "20%" },
			{ "title": "Author", "width": "20%" }
		]
	
	} );
	
	$('#example tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
        	
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            var codingID = $(this).find("td").eq(0).html();
            //window.alert(codingID); // FIXME
            
            activateCodingInEditor(codingID);
            
        }
    } );
    	
} );

function activateCodingInEditor(codingID){
	gapi.client.qdacity.documents.getTextDocument({'id': project_id}).execute(function(resp){
	    		 if (!resp.code) {
	    			resp.items = resp.items || [];
  	    		for (var i=0;i<resp.items.length;i++) {
  	    			var elements = $(resp.items[i].text);
  	    			var foundArray = $('coding[id=\''+codingID+'\']', elements).map(function() {
  	    				return $(this);
  	                  
  	              });
  	    			foundArray = foundArray.toArray();

  	    			if (foundArray.length > 0) {
  	    				var range;
  	    				range = document.createRange();

  	    			  	editor.setHTML(resp.items[i].text);
  	    			  	var node = $("#editor").contents().find('coding[id=\''+codingID+'\']')[0]; // FIXME for multiple node codings
  	    			  raWnge = iframe.contentDocument.createRange();
  	    	        range.setStart(node, 0);
  	    	        range.setEnd(node, node.childNodes.length);
  	    	        editor.setSelection(range);
  	    			  	
  	    			}
              	}
	    		 }

	    	 });
}
	</script>
    
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
      <style>
  #feedback { font-size: 1.4em; }
  #documentlist .ui-selecting { background: #BBB; }
  #documentlist .ui-selected { background: #777; color: white; }
  #documentlist { list-style-type: none; margin: 0; padding: 0; width: 100%; }
  #documentlist li { margin: 2px;  height: 20px; }
  </style>
  <script>
  //FIXME
  $(function() {
    $( "#documentlist" ).selectable({
        stop: function() {
        	var ids = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	ids = ids.toArray();
        	var selectedID = ids[0];
        	setDocumentView(selectedID);//FIXME
          }
        });
  });
  </script>
</head>
<body>
<div class="row">
<div class=col-md-12 >
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top topnav" role="navigation">
        <div class="container topnav">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand topnav" href="index.html">QDAcity</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="index.html#about">About</a>
                    </li>
                    <li>
                        <a href="apitest.html">API Test</a>
                    </li>
                    <li>
                        <a href="index.html#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>

        <!-- /.container -->
    </nav>
            </div>
            </div>
    <div class="row no-gutters" >
    <div class=col-md-2 >
    <div id="documents-ui"; style="float:left; width:100%; background-color: #f8f8f8; margin-top:50px;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<b>Documents</b><br>
			<div class="btn-group" >
			<a id="btnUpdateDoc" class="btn btn-default" href="#">
			  <i class="fa fa-pencil fa-1x"></i>
			</a>
			<a id="btnInsertDoc" class="btn btn-default" href="#">
			  <i class="fa fa-plus fa-1x"></i>
			</a>
			<a id="btnRemoveDoc" class="btn btn-default" href="#">
			  <i class="fa fa-trash fa-1x"></i>
			</a>
			</div>
			<div class="btn-group" >
			</div>
			</div>
		</div>
		 <div id="document-section" style="padding-left:2px; padding-right:2px;  text-align: left; border: 2px solid #e7e7e7;">
			<ol id="documentlist">

			</ol>
	    </div>
	</div>
	
     <div id="codesystem-ui"; style="float:left; width:100%; background-color: #f8f8f8; margin-top:5px;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<b>Code System</b><br>
			<div class="btn-group" >
			<a id="btnUpdateCode" class="btn btn-default" href="#">
			  <i class="fa fa-pencil fa-1x"></i>
			</a>
			<a id="btnInsertCode" class="btn btn-default" href="#">
			  <i class="fa fa-plus fa-1x"></i>
			</a>
			<a id="btnRemoveCode" class="btn btn-default" href="#">
			  <i class="fa fa-trash fa-1x"></i>
			</a>
			<a id="btnCodeProps" class="btn btn-default" href="#">
			  <i class="fa  fa-list-alt  fa-1x"></i>
			</a>
			</div>
			<div class="btn-group" >
			
			
			<a id="btnApplyCode" class="btn btn-default" href="#">
			<span class="fa-stack fa-lg" style= "font-size: 8px;">
			  <i class="fa fa-tag fa-stack-2x"></i>
			  <i class="fa fa-plus fa-stack-1x fa-inverse"></i>
			</span>
			</a>
			<a id="btnRemoveCoding" class="btn btn-default" href="#">
			  <span class="fa-stack fa-lg" style= "font-size: 8px;">
			  <i class="fa fa-tag fa-stack-2x"></i>
			  <i class="fa fa-minus fa-stack-1x fa-inverse"></i>
			</span>
			</a>
			</div>
			</div>
		</div>
		 <div id="easytree-section" style="padding-left:2px; padding-right:2px;  text-align: left; border: 2px solid #e7e7e7;">
			
	        <ul>
	        </ul>
	    </div>
	</div>
	<div style="float:left; width:100%; background-color: #f8f8f8; margin-top:5px;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<b>Debug</b><br>
			<a id="btnShowHTML" class="btn btn-default btn-sm" href="#">
  				<i class="fa fa-file-text "></i> HTML</a>
			<div id="listCodesResult"></div>
			</div>
		</div>
	</div>
	

</div>
  <div class=col-md-10 style="background-color: #FFF; margin-top:50px;margin-bottom:50px; height=100%;">
    
    <div id="textdocument-ui";>
		<iframe id="editor" height="100%" width="100%">
		<div>
		<h1>Test Text</h1><br>
	        This test text is used to test the text for testing purposes.<br>
	        This is another test text.<br>
	        When you want to test, you can use this text.<br>
	        Test texts are a good way to test something.<br>
	        Here is some more text.<br>
	        Not done testing? More text.<br>
	        </div>
	        </iframe>
	    
	    </div>
	    <div id="login" class="testapi">
	 <div id="login" >
       <input id="loginButton" type="button" value="Login"/>
    </div>
	
	
    </div>
</div>
</div>

<footer id="footer" class="footer">
<div style="float: right; background-color: #e7e7e7;"><i id="btnHideFooter" class="fa fa-times-circle fa-2x fa-hover" ></i> </div> 
<!-- float: left; -->
<div class="center" style=" text-align: center; background-color: #e7e7e7;"><b>Code Properties</b></div>
<div id="codingtable"></div>
      
 </footer>

<div id="new-code-form" title="Code Properties">
  <p class="validateTips"></p>
 
  <form >
    <fieldset>
    <table id="addCodeTable" style="padding-left: 10px;">
    <tbody>
      <tr>
        <td><label for="newCodeName">Code Name</label></td>
        <td><input type="text" name="newCodeName" id="newCodeName" value="Code Name" class="text ui-widget-content ui-corner-all"></td>
      </tr>
      <tr>
      <td>
      <label for="newCodeAuthor">Author</label>
      </td>
      <td>
      <input type="text" name="newCodeAuthor" id="newCodeAuthor" value="Author" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
      <tr>
      <td>
      <label for="newCodeID">ID</label>
      </td>
      <td>
      <input type="text" name="newCodeID" id="newCodeID" value="" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
    </tbody>
  </table>
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
<div id="update-code-form" title="Code Properties">
  <p class="validateTips"></p>
 
  <form >
    <fieldset>
    <table id="changeCodeTable" style="padding-left: 10px;">
    <tbody>
   	  <tr>
      <td>
      <label for="updateCodeID">ID</label>
      </td>
      <td>
      <div id="updateFormCodeId"></div>
      </td>
      </tr>
      <tr>
        <td><label for="updateCodeName">Code Name</label></td>
        <td><input type="text" name="updateCodeName" id="updateCodeName" value="Code Name" class="text ui-widget-content ui-corner-all"></td>
      </tr>
      <tr>
      <td>
      <label for="updateCodeAuthor">Author</label>
      </td>
      <td>
      <input type="text" name="updateCodeAuthor" id="updateCodeAuthor" value="Author" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
      
    </tbody>
  </table>
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
<div id="debugTextEditor" title="HTML">
  
</div>
<script type="text/template" id="editorStyles">
  html {
    height: 100%;
  }
  body {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    height: 100%;
    padding: 1em;
    background: transparent;
    color: #2b2b2b;
    font: 13px/1.35 Helvetica, arial, sans-serif;
    cursor: text;
  }
  a {
    text-decoration: underline;
  }
  h1 {
    font-size: 138.5%;
  }
  h2 {
    font-size: 123.1%;
  }
  h3 {
    font-size: 108%;
  }
  h1,h2,h3,p {
    margin: 1em 0;
  }
  h4,h5,h6 {
    margin: 0;
  }
  ul, ol {
    margin: 0 1em;
    padding: 0 1em;
  }
  blockquote {
    border-left: 2px solid blue;
    margin: 0;
    padding: 0 10px;
  }
</script>

<script src="https://apis.google.com/js/platform.js?onload=onLoad" async defer></script>
    <script type="text/javascript">

          
	    var scopes = 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
	    var client_id = '309419937441-6d41vclqvedjptnel95i2hs4hu75u4v7.apps.googleusercontent.com';
	    var current_user_name;
	    var current_user_id;
	    var codesystem_id;
	    var active_code;
	    var project_id;
	    var documentMap;
	    var currentText;
	    var max_coding_id;
	    
	    var editor;
	    var iframe = document.getElementById( 'editor' );
	    $(document).ready( function () {
	      // Make sure we're in standards mode.
	      var doc = iframe.contentDocument;
	      $("iframe").css({  height : $(window).height() -52});
	      if ( doc.compatMode !== 'CSS1Compat' ) {
	          doc.open();
	          doc.write( '<!DOCTYPE html><title></title>' );
	          doc.close();
	      }
	      
	      doc.open();
          doc.write( '<!DOCTYPE html><title>test</title>asd' );
          doc.close();
	      // doc.close() can cause a re-entrant load event in some browsers,
	      // such as IE9.
	      if ( editor ) {
	          return;
	      }
	      // Create Squire instance
	      editor = new Squire( doc, {
	          blockTag: 'p',
	          blockAttributes: {'class': 'paragraph'},
	          tagAttributes: {
	              ul: {'class': 'UL'},
	              ol: {'class': 'OL'},
	              li: {'class': 'listItem'}
	          }
	      });
	   // Add styles to frame
	      var style = doc.createElement( 'style' );
	      style.type = 'text/css';
	      style.textContent = document.getElementById( 'editorStyles' ).textContent;
	      doc.querySelector( 'head' ).appendChild( style );
	    });
	    
	    window.onresize = resizeElements;
	    
	    function resizeElements(){
	    	$("iframe").css({  height : $(window).height() -52});
	    }
	    
	    var easytree = $('#easytree-section').easytree({
            enableDnd: true,
            dropped: dropped,
            stateChanged: codesystemStateChanged
        });
	    
	    function handleAuth() {
		  var request = gapi.client.oauth2.userinfo.get().execute(function(resp) {
		    if (!resp.code) {
		      // User is signed in, so hide the button
		      document.getElementById('loginButton').style.visibility = 'hidden';
		      document.getElementById('login').innerText = 'Welcome ' + resp.name;
		      current_user_name = resp.given_name;
		      current_user_id = resp.id;
		    }
		    else {
		    	document.getElementById('loginButton').style.visibility = '';
		    }
		  });
		}
	    
	    function signin(mode, callback) {
	    	  gapi.auth.authorize({client_id: client_id,scope: scopes, immediate: mode},callback);
	    }
    
        function init() {
        	$.LoadingOverlay("show");
        	$( "#footer" ).hide();
        	var query = window.location.search;
        	  // Skip the leading ?, which should always be there,
        	  // but be careful anyway
        	  if (query.substring(0, 1) == '?') {
        	    query = query.substring(1);
        	  }
        	  var data = query.split(',');
        	  for (i = 0; (i < data.length); i++) {
        	    data[i] = unescape(data[i]);
        	  }
        	  project_id = data[0];
        	  
        	var apisToLoad;
        	 var callback = function() {
        	   if (--apisToLoad == 0) {
        	     signin(true, handleAuth);
        	     //Load project settings
        	     gapi.client.qdacity.project.getProject({'id': data[0]}).execute(function(resp) {
        	    	 if (!resp.code) {
        	    		 codesystem_id = resp.codesystemID;
	        	    	 listCodes();
	        	    	 setDocumentList(project_id);
        	    	 }
        	    	 else{
        	    		window.alert("Project could not be loaded");	 
        	    	}
        	    	 $.LoadingOverlay("hide");
        	    	 
        	     });
        	     

        	   }
        	   
        	}
        	  
        	apisToLoad = 2;
        	//Parameters are APIName,APIVersion,CallBack function,API Root 
        	//gapi.client.load('qdacity', 'v1', callback, 'https://localhost:8888/_ah/api');
        	gapi.client.load('qdacity', 'v1', callback, 'https://qdacity-app.appspot.com/_ah/api');
        	gapi.client.load('oauth2','v2',callback);
        	
        	                
                document.getElementById('btnCodeProps').onclick = function() {
                	$( "#footer" ).show( "clip", {}, 250, {} );
                	var activeID = getActiveId();
                	fillCodingTable(activeID);
                	
                  }
                
                document.getElementById('btnRemoveCode').onclick = function() {
                    deleteCode();
                }
                
                document.getElementById('btnApplyCode').onclick = function() {
                	var activeID = getActiveId();
                	if (typeof activeID != 'undefined'){
                		gapi.client.qdacity.project.incrCodingId({'id': project_id}).execute(function(resp){
                			var codingID = resp.maxCodingID;
                			window.alert(codingID);
                			var author = "User";	
                			editor.insertHTML('<coding id="'+ codingID +'" code_id="' + activeID + '" author="'+ author +'" style="background-color: #00e7e7;">'+ editor.getSelectedText() + '</coding>');	
                			easytree.getNode(activeID).codingCount++;
                			easytree.rebuildTree();
                			saveEditorContent();
                		});
                		
                	}
                  }
                
                document.getElementById('btnInsertDoc').onclick = function() {
                	addDocumentToProject();
            	}  
                
                document.getElementById('btnRemoveDoc').onclick = function() {
                	removeDocumentFromProject();
            	}  
                
                document.getElementById('btnUpdateDoc').onclick = function() {
                	changeDocumentTitle();
            	}  
                
                
                document.getElementById('loginButton').onclick = function() {
            		signin(false,handleAuth);
            	}  
                
                document.getElementById('btnHideFooter').onclick = function() {
                	$( "#footer" ).hide( "clip", {}, 250, {} );
            	}  
                
                document.getElementById('btnRemoveCoding').onclick = function() {
                	
            	}  

 				document.getElementById('btnShowHTML').onclick = function() {
 					
 					$( "#debugTextEditor" ).dialog();
 					document.getElementById('debugTextEditor').innerHTML = "<xmp>" + editor.getHTML() + "</xmp>";
 					$( "#debugTextEditor" ).dialog( "option", "show", { effect: "blind", duration: 800 } );
            	}  
                
                
        }
        
        function fillCodingTable(codeID){
        	var table = $('#example').DataTable();
        	
        	table.clear();
        	
        	var codings = [];
        	gapi.client.qdacity.documents.getTextDocument({'id': project_id}).execute(function(resp){
	    		 if (!resp.code) {
	    			resp.items = resp.items || [];
	    			table.clear();
  	    		for (var i=0;i<resp.items.length;i++) {
  	    			var elements = $(resp.items[i].text);
  	    			var found = $('coding', elements);
  	    			var foundArray = $('coding[code_id=\''+codeID+'\']', elements).map(function() {
  	    				var tmp = {};
  	    				tmp.id = $(this).attr('id');
  	    				tmp.code_id = $(this).attr('code_id');
  	    				tmp.author = $(this).attr('author');
  	                  return tmp;
  	                  
  	              });
  	    			foundArray = foundArray.toArray();

  	    			for (var j=0;j<foundArray.length;j++) {
  	    			  	table.row.add( [ foundArray[j].id, resp.items[i].title, foundArray[j].author] );
  	    			  
  	    			}
              	}
  	    		table.draw();
	    		 }

	    	 });
        }
        
        function getCodingCount(codeId){
        	
        }
        
        function setDocumentList(projectID){
        	$("#documents-ui").LoadingOverlay("show");
        	gapi.client.qdacity.documents.getTextDocument({'id': project_id}).execute(function(resp){
	    		 if (!resp.code) {
	    			resp.items = resp.items || [];
   	    		for (var i=0;i<resp.items.length;i++) {
   	    			addDocumentToList(resp.items[i].id, resp.items[i].title);
   	    			//documentMap[i] = resp.items[i].id;
               	}
	    		 }
	    		 $("#documents-ui").LoadingOverlay("hide");
	    	 });
        }
        
        function addDocumentToProject(){
        	var title = prompt("Name the document", "Title");

        	if (title == null) {
        	    return;
        	}
        	var requestData = {};
            requestData.projectID = project_id;
            requestData.text = "My text";
            requestData.title = title;
            
            gapi.client.qdacity.documents.insertTextDocument(requestData).execute(function(resp) {
                    if (!resp.code) {
                    	document.getElementById('documentlist').innerHTML = "";
                    	setDocumentList(project_id);
                    }
            });
                
        }
        
        function removeDocumentFromProject(){
        	var ids = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	
        	ids = ids.toArray();
        	for (var i=0;i<ids.length;i++) {
        		var requestData = {};
        		requestData.id = ids[i];
                gapi.client.qdacity.documents.removeTextDocument(requestData).execute(function(resp) {
                	document.getElementById('documentlist').innerHTML = "";
                	setDocumentList(project_id);   
                })
        	}
        }
        
        function changeDocumentTitle(){
        	var ids = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	ids = ids.toArray();
        	var title = prompt("New name for document \"" + ids[0] + "\"", "Title");
        	changeDocumentData(ids[0], title);
        }
        
        function changeDocumentData(id, title){
        	
        		var requestData = {};
        		
        		requestData.id = id;
        		requestData.title = title;
        		requestData.text = editor.getHTML();
        		requestData.projectID = project_id;
        		//FIXME text
                gapi.client.qdacity.documents.updateTextDocument(requestData).execute(function(resp) {
                	document.getElementById('documentlist').innerHTML = "";
                	setDocumentList(project_id);   
                });
        }
        
        function setDocumentView(textDocumentID){
        	$("#textdocument-ui").LoadingOverlay("show");
        	gapi.client.qdacity.documents.getTextDocument({'id': project_id}).execute(function(resp){
	    		 if (!resp.code) {
	    			resp.items = resp.items || [];
  	    		for (var i=0;i<resp.items.length;i++) {
  	    			if (resp.items[i].id == textDocumentID){
  	    				if (typeof resp.items[i].text  == 'undefined') window.alert("No content for this document"); // FIXME
  	    				editor.setHTML(resp.items[i].text);
  	    			}
              	}
	    		 }
	    		 $("#textdocument-ui").LoadingOverlay("hide");
	    	 });
        	
        }
        
        //List Codes function that will execute the listCode call
        function listCodes() {
        	$("#codesystem-ui").LoadingOverlay("show");
        	var codes = [];
                gapi.client.qdacity.codesystem.getCodeSystem({'id': codesystem_id}).execute(function(resp) {
                        if (!resp.code) {
                                resp.items = resp.items || [];
                                var result = "";
                                
                                for (var i=0;i<resp.items.length;i++) {
                                        result = result+ resp.items[i].name + "..." + "<b>" + resp.items[i].author + "</b>" + "[" + resp.items[i].id + "]" + "   {" + resp.items[i].subCodesIDs + "}" + "<br/>";
                                        
                                        codes.push(resp.items[i]);
                                }
                                document.getElementById('listCodesResult').innerHTML = result;
                                for(var i=0;i<codes.length;i++) {
                                	addNodeToTree(codes[i].id, codes[i].name);
                                }
                                
                                for(var i=0;i<codes.length;i++) {
                                	if (typeof codes[i].subCodesIDs != 'undefined')
                                	{
	                                	if (codes[i].subCodesIDs.length > 0){
	                                		
		                                	for(var j=0;j<codes.length;j++) {
		                                		for(var k=0; k < codes[i].subCodesIDs.length; k++){
		                                			if (codes[i].subCodesIDs[k] == codes[j].id){
		                                				relocateNode(codes[j].id, codes[i].id);
		                                			}
		                                		}
		                                	}
		                                	
	                                    }
                                	}
                                }
                        }
                        addCodingCountToTree();
                        $("#codesystem-ui").LoadingOverlay("hide");
                });
        }
        
     
        
        

        //Insert Code function
        function insertCode(_AuthorName, _CodeName, _ID) {
        	var activeID = getActiveId();
                //Build the Request Object
                var requestData = {};
                requestData.author = _AuthorName;
                requestData.name = _CodeName;
                requestData.id = _ID;
                requestData.subCodesIDs = new Array();
                requestData.parentID = activeID;
                requestData.codesytemID = codesystem_id;
                
                gapi.client.qdacity.codes.insertCode(requestData).execute(function(resp) {

                	console.log(resp.id + ":" + resp.author + ":" + resp.name);
                        if (!resp.code) {
                                //Just logging to console now, you can do your check here/display message
                                console.log(resp.id + ":" + resp.author + ":" + resp.name);
                                document.getElementById('listCodesResult').innerHTML = resp.id + ":" + resp.author + ":" + resp.name;
                                addNodeToTree(resp.id, resp.name);
                                if (typeof activeID != 'undefined'){
                                	addSubCode(activeID, _ID);
                                	relocateNode(_ID, activeID);
                                }
                        }
                });
        }
        
        //Update Code function
        function updateCode(_AuthorName, _CodeName, _ID) {
                //Build the Request Object
                var requestData = {};
                requestData.id = _ID;
                requestData.author = _AuthorName;
                requestData.name = _CodeName;
                requestData.codesytemID = codesystem_id;
                gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
                        if (!resp.code) {
                                //Just logging to console now, you can do your check here/display message
                                console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
                                changeNodeName(resp.id, resp.name);
                        }
                });
        }
        
        
        
        function relocateCode(codeId, newParentId){
        	removeLinkFromOldParent(codeId);
        	
        	addSubCode(newParentId, codeId);
        	
        	changeParentId(codeId, newParentId);
        }
        
        //Add SubCode function FIXME
        function addSubCode(_ID, _SubID) {
            //var _ID = document.getElementById("parentCodeID").value;
            //var _SubID = document.getElementById("childCodeID").value;
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	          
            	          var code = {};
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            requestData.codesytemID = resp.codesytemID;
            	            if (typeof resp.subCodesIDs == 'undefined'){
            	            	 requestData.subCodesIDs = [_SubID];
            	            }
            	            else {
            	            	requestData.subCodesIDs = resp.subCodesIDs.concat(_SubID);
            	            }
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    	//relocateNode(_SubID, _ID);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function changeParentId(_ID, _newParent) {
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            requestData.subCodesIDs = resp.subCodesIDs;
            	            requestData.parentID = _newParent;
            	            requestData.codesytemID = resp.codesytemID;
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function removeSubCode(_ID, _SubID) {
            //Validate the entries
           // var _ID = document.getElementById("parentCodeID").value;
           // var _SubID = document.getElementById("childCodeID").value;
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	          
            	          var code = {};
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            requestData.codesystemID = resp.codesystemID;
            	            for(var i = resp.subCodesIDs.length - 1; i >= 0; i--) {
            	            	
            	                if(resp.subCodesIDs[i] === _SubID) {
            	                	
            	                	resp.subCodesIDs.splice(i, 1);
            	                }
            	            }
            	            requestData.subCodesIDs = resp.subCodesIDs;
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                            //Just logging to console now, you can do your check here/display message
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function removeLinkFromOldParent(codeId) {

            gapi.client.qdacity.codes.getCode({'id': codeId}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
	            	          	if (typeof resp.parentID != 'undefined'){
	            	          		removeSubCode(resp.parentID, codeId);
	            	          	}
            	          }
        	 });
    	}
        
        
        
        //Delete code function
        function deleteCode() {
        	var activeID = getActiveId();
        	if (typeof activeID == 'undefined'){
        		window.alert("No code selected");
        		return;
        	}
        	else
       		{
	            //Build the Request Object
	            var requestData = {};
	            requestData.id = activeID;
	            console.log(requestData);
	            gapi.client.qdacity.codes.removeCode(requestData).execute(function(resp) {
	                    //Just logging to console now, you can do your check here/display message
	                    console.log(resp);
	                    removeNodeFromTree(activeID);
	            });
       		}
                
        }
        
        function setNameAndAuthor(codeId, nameField, authorField){
        	gapi.client.qdacity.codes.getCode({'id': codeId}).execute(function(resp) {
            	
  	          if (!resp.code) {
  	        	document.getElementById(nameField).value = resp.name;
  	        	document.getElementById(authorField).value = resp.author;
  	          }  	          
	 });
        }
        
        $(function() {
        
            var dialog, form,
            name = $( "#newCodeName" ),
            email = $( "#newCodeAuthor" ),
            password = $( "#newCodeID" ),
            allFields = $( [] ).add( name ).add( email ).add( password ),
              tips = $( ".validateTips" );
         
         
            function addCode() {
            	var name = document.getElementById('newCodeName').value,
                author = document.getElementById('newCodeAuthor').value,
                id = document.getElementById("newCodeID" ).value;

              insertCode(author,name,id);
              dialog.dialog( "close" );
              form[ 0 ].reset();
            }
         
            dialog = $( "#new-code-form" ).dialog({
              autoOpen: false,
              height: 350,
              width: 450,
              modal: true,
              buttons: {
                "Add code": addCode,
                Cancel: function() {
                  dialog.dialog( "close" );
                }
              },
              close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
                
              }
            });
         
            form = dialog.find( "form" ).on( "submit", function( event ) {
              event.preventDefault();
              addCode();
            });
         
            $( "#btnInsertCode" ).on( "click", function() {
              dialog.dialog( "open" );
            });
            
          });
        
        $(function() {
            var dialog, form,
            name = $( "#updateCodeName" ),
            email = $( "#updateCodeAuthor" ),
            password = $( "#updateCodeID" ),
            allFields = $( [] ).add( name ).add( email ).add( password ),
              tips = $( ".validateTips" );
         
         
            function changeCode() {
            	var name = document.getElementById('updateCodeName').value,
                author = document.getElementById('updateCodeAuthor').value,
                id = getActiveId();

              updateCode(author,name,id);
              dialog.dialog( "close" );
              form[ 0 ].reset();
            }
         
            dialog = $( "#update-code-form" ).dialog({
              autoOpen: false,
              height: 350,
              width: 450,
              modal: true,
              buttons: {
                "Modify code": changeCode,
                Cancel: function() {
                  dialog.dialog( "close" );
                }
              },
              close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
                
              }
            });
         
            form = dialog.find( "form" ).on( "submit", function( event ) {
              event.preventDefault();
              changeCode();
            });
         
            $( "#btnUpdateCode" ).on( "click", function() {
              document.getElementById('updateFormCodeId').innerHTML = getActiveId();
              setNameAndAuthor( getActiveId(), 'updateCodeName', 'updateCodeAuthor');
              dialog.dialog( "open" );
            });
          });
        
        function addNodeToTree(id, name) {
			var sourceNode = {};
            sourceNode.text = name;
            sourceNode.isFolder = true;
            sourceNode.id = id;
            sourceNode.codingCount = 12;
            sourceNode.uiIcon = "ui-icon-tag";
           
           sourceNode.onclick = function() {
        	   window.alert("test");
           }
			
            easytree.addNode(sourceNode);
            easytree.rebuildTree();
            //loadSelectBox();
        }
        
        function addCodingCountToTree(){
        	gapi.client.qdacity.documents.getTextDocument({'id': project_id}).execute(function(resp){
	    		 if (!resp.code) {
	    			 var nodes = easytree.getAllNodes();
	    			 var codeIDs = getAllCodeIds(nodes);
	    			for (var i = 0;  i < codeIDs.length; i++) {
		    			resp.items = resp.items || [];
		    			var codingCount = 0;
			    		for (var j=0;j<resp.items.length;j++) {
			    			var elements = $(resp.items[j].text);
			    			var foundArray = $('coding[code_id=\''+codeIDs[i]+'\']', elements).map(function() {
			                  return $(this).attr('id');
			              	});
			    			codingCount += foundArray.length;
		           		}
			    		var node = easytree.getNode(codeIDs[i]);
			    		
			    		node.codingCount = codingCount;
	    			}
	    			 easytree.rebuildTree();
	    		 }
	    		
	    	 });
           
        }
        
        function removeNodeFromTree(id) {
            
            easytree.removeNode(id);
            easytree.rebuildTree();
        }
        
        function relocateNode(id, target) {
        	
            var sourceNode = easytree.getNode(id);
            sourceNode.isFolder = true;
            var targetId = target;
            easytree.removeNode(id);
			
            easytree.addNode(sourceNode, target);
            easytree.rebuildTree();
        }
        
		function changeNodeName(id, name) {
        	
            var sourceNode = easytree.getNode(id);
            sourceNode.text = name;

            easytree.rebuildTree();
        }
		
		function getActiveId() {
            var nodes = easytree.getAllNodes();
            return getActiveIdRecursive (nodes);
            
        }
		
		function getActiveIdRecursive(nodes) {
			for (var i = 0;  i < nodes.length; i++) {
            	if (nodes[i].isActive == true){
            		return nodes[i].id;
            	}
            	if (nodes[i].children && nodes[i].children.length > 0) {
                    var result = getActiveIdRecursive(nodes[i].children);
                    if (typeof result != 'undefined') return result;
                }
            }
        }
		
		function getAllCodeIds(nodes) {
			var ids = [];
			for (var i = 0;  i < nodes.length; i++) {
            	ids.push(nodes[i].id);
            	if (nodes[i].children && nodes[i].children.length > 0) {
            		
                    var result = getAllCodeIds(nodes[i].children);
                    ids = ids.concat(result);
                }
            }
			return ids;
        }
		
		
		
		function dropped(event, nodes, isSourceNode, source, isTargetNode, target) {
			
            if (isSourceNode && isTargetNode) { // internal to internal drop
            	relocateCode(source.id, target.id);
            }
        }
		
		var initialized_easytree = false;
		function codesystemStateChanged(nodes, nodesJson) {
			if (initialized_easytree){
			active_code = getActiveId();
				if ($("#footer").is(":visible")){
					fillCodingTable(active_code);
				} 
			}
			else{
				initialized_easytree = true;
			}
	    }
		
		var listCreated = false;
        
		
        function addDocumentToList(docID, newItem){
        	//window.alert("<li class=\"ui-widget-content\" data-docID=\""+ docID +"\">" + newItem + "</li>");
            $("#documentlist").append("<li class=\"ui-widget-content\" docID=\""+ docID +"\">" + newItem + "</li>");
            //$("#documentlist").listview("refresh");
            
        }
		  
    </script>
    <script src="https://apis.google.com/js/client.js?onload=init"></script>
</body>
</html>
