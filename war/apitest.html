<!DOCTYPE html>
<html lang="en">
<html>
<head>

	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>QDAcity API Test</title>
     <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

     
    <!-- Bootstrap Core CSS -->
    <link href="components/bootstrap/bootstrap.min.css" rel="stylesheet">
    
    
    <!-- Custom CSS -->
    <link href="assets/css/landing-page.css" rel="stylesheet">
    <link href="assets/css/footer.css" rel="stylesheet">
  	<link href="components/tooltipster/css/tooltipster.css" rel="stylesheet">
    

    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="components/tooltipster/js/jquery.tooltipster.js"></script>
    
    
    
    <!-- EasyTree -->
	<link rel="stylesheet" type="text/css" href="components/EasyTree/skin-win8/ui.easytree.css">
	<script type="text/javascript" src="components/EasyTree/jquery.easytree.js"></script>
	
    <script type="text/javascript" src="components/loading/loadingoverlay.js"></script>
   <script type="text/javascript" src="components/DataTables-1.10.7/media/js/jquery.dataTables.min.js"></script>
    
    <script type="text/javascript" src="components/Squire/squire-raw.js"></script>
    
    <script type="text/javascript" src="components/Easytabs/jquery.easytabs.js"></script>
    <link href="components/Easytabs/easytabs.css" rel="stylesheet"> 
    
    
    
    <!-- Custom Fonts -->
    <link href="components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
    
    <link href="components/DataTables-1.10.7/media/css/jquery.dataTables.css" rel="stylesheet"> <!-- FIXME move to css folder -->
      
      
      
        <style>
  .custom-combobox {
    position: relative;
    display: inline-block;
  }
  .custom-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
  }
  .custom-combobox-input {
    margin: 0;
    padding: 5px 10px;
  }
  </style>
  <style>
  .navbar-content
{
    width:320px;
    padding: 15px;
    padding-bottom:0px;
}
.navbar-content:before, .navbar-content:after
{
    display: table;
    content: "";
    line-height: 0;
}
.navbar-footer 
{
    background-color:#DDD;
}
.navbar-footer-content { padding:15px 15px 15px 15px; }
.dropdown-menu {
padding: 0px;
overflow: hidden;
}
  </style>
  <style type="text/css"> /* FIXME Scrollbar Styling */
  body, html { 
    overflow-y: hidden;
}</style>
        <style>
    .validateTips { border: 1px solid transparent; padding: 0.3em; }
  </style>
  <style>
  iframe {
    border: 1px solid #888;
    width: 100%;
    height: 100px;
  }

/* .col-sm-10
{
    background-color: green;
    overflow: auto;
    height: 90vh;
} */


  </style>
  
    <script type="text/javascript">
        function saveEditorContent() {
			var docIDs = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	var docTitles = $('#documentlist .ui-selected').map(function() {
                return $(this).text();
                
            });
        	changeDocumentData(active_document.id, active_document.title);
		}
    </script>
    
    <script type="text/javascript" language="javascript" class="init">


var dataSet = [];

$(document).ready(function() {
	$('#codingtable').html( '<table cellpadding="0" cellspacing="0" border="0" class="display" id="example"></table>' );

	var table = $('#example').dataTable( {
		"iDisplayLength": 7,
		"bLengthChange": false,
		"data": dataSet,
		"autoWidth": false,
		"columnDefs": [
		               { "width": "5%"},
		               { "width": "20%"},
		               { "width": "20%"}
		             ],
		"columns": [
			{  "title": "ID" , "width": "5%",},
			{ "title": "Document", "width": "20%" },
			{ "title": "Author", "width": "20%" }
		]
	
	} );
	
	$('#example tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
        }
        else {
        	
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            var codingID = $(this).find("td").eq(0).html();
            
            activateCodingInEditor(codingID);
            
        }
    } );
	
        
    	
} );

function activateCodingInEditor(codingID){

  	    		for (var id in text_documents) {
  	    			var elements = text_documents[id].text;
  	    			var foundArray = $('coding[id=\''+codingID+'\']', elements).map(function() {
  	    				return $(this);
  	                  
  	              });
  	    			foundArray = foundArray.toArray();

  	    			if (foundArray.length > 0) {
  	    				var range;
  	    				range = document.createRange();
  	    				$('#documentlist .ui-selected').removeClass( "ui-selected" );
  	    				$("#documentlist").find("li[docID='" +id + "']").addClass( "ui-selected" );
  	    			  	setDocumentView(id);
  	    			  	var codingNodes = $("#editor").contents().find('coding[id=\''+codingID+'\']');
  	    			  	var startNode = codingNodes[0];
  	    			  	var endNode = codingNodes[codingNodes.length -1];
  	    			  	
  	    			  raWnge = iframe.contentDocument.createRange();
  	    	        range.setStart(startNode, 0);
  	    	        range.setEnd(endNode, endNode.childNodes.length);
  	    	        editor.setSelection(range);
  	    	        //Scroll to selection
  	    	        var offset = startNode.offsetTop;
  	    	      	$("#editor").contents().scrollTop(offset) ;
  	    			  	
  	    			}
              	}
	    		 
}

function addTooltipsToEditor(id){

		var elements = text_documents[id].text;
		var foundArray = $("#editor").contents().find('coding');
      
		foundArray = foundArray.toArray();

		for(var i = 0; i<foundArray.length; i++) {
		  	var node = foundArray[i];
		  	$(node).tooltip({"content":"Code ["+$(node).attr('codeName')+"]", placement: 'top'});
		  	
		}
  	
	 
}
	</script>
    
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="components/tooltip/tooltip.js"></script>
<link rel="stylesheet" href="components/tooltip/tooltip.css">

<script src="components/colorpicker/evol.colorpicker.js" type="text/javascript" charset="utf-8"></script>
    <link href="components/colorpicker/evol.colorpicker.css" rel="stylesheet" type="text/css">
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
      <style>
  #feedback { font-size: 1.4em; }
  #documentlist .ui-selecting { background: #BBB; }
  #documentlist .ui-selected { background: #777; color: white; }
  #documentlist { list-style-type: none; margin: 0; padding: 0; width: 100%; }
  #documentlist li { margin: 2px;  height: 20px; }
  </style>
  <style>
	  .edit-toggle .edit-toggle-off,
	.edit-toggle.collapsed .edit-toggle-on {
	    display: none;
	}
	.edit-toggle.collapsed .edit-toggle-off,
	.edit-toggle .edit-toggle-on {
	    display: inline-block;
	}
  </style>
  <script>
  //FIXME
  $(function() {
    $( "#documentlist" ).selectable({
        stop: function() {
        	var ids = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	var docTitles = $('#documentlist .ui-selected').map(function() {
                return $(this).text();
                
            });
        	ids = ids.toArray();
        	var selectedID = ids[0];
        	active_document.id = ids[0];
        	active_document.title = docTitles[0];
        	setDocumentView(selectedID);//FIXME
          }
        });
  });
  </script>
  
</head>
<body>
<div class="row">
<div class=col-sm-12 >
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top topnav" role="navigation">
        <div class="container topnav">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand topnav" href="index.html">QDAcity</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="index.html#about">About</a>
                    </li>
                    <li>
                        <a href="apitest.html">API Test</a>
                    </li>
                    <li>
                        <a href="index.html#contact">Contact</a>
                    </li>
                    
                                    <li id="navAccount" class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Account
                                        <b class="caret"></b></a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <div class="navbar-content">
                                                    <div class="row">
                                                        <div class="col-md-5">
                                                            <img id="currentUserPicture" src=""
                                                                alt="Alternate Text" class="img-responsive" />
                                                            <p class="text-center small">
                                                                <a href="#">Change Photo</a></p>
                                                        </div>
                                                        <div class="col-md-7">
                                                            <span id="currentUserName"></span>
                                                            <p id="currentUserEmail" class="text-muted small"></p>
                                                            <div class="divider">
                                                            </div>
                                                            <a href="#" class="btn btn-primary btn-sm active">View Profile</a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="navbar-footer">
                                                    <div class="navbar-footer-content">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <a href="#" class="btn btn-default btn-sm">Sign in as different User</a>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <a id="navBtnSignOut" class="btn btn-default btn-sm pull-right">Sign Out</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                                    <li  id="navSignin" class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Sign In
                                        <b class="caret"></b></a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <div class="navbar-content">
                                                    <div class="row">
                                                        <div class="col-md-12" style="text-align:center; padding-bottom:15px;">
                                                        <a id ="navBtnSigninGoogle" class="btn  btn-primary" href="#">
  																	<i class="fa fa-google fa-2x pull-left" ></i> <span style="font-size:18px;">Sign in with Google</span></a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="navbar-footer">
                                                    <div class="navbar-footer-content">
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                            	
                                                                
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>

        <!-- /.container -->
    </nav>
            </div>
            </div>
    <div class="row no-gutters">
    <div class=col-sm-2 >
    
    <!-- SETTINGS -->
    <div id="project-ui"; style="float:left; width:100%; background-color: #f8f8f8; margin-top:50px;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<div class="tooltips" title="test"><b >Settings</b><br></div>
			<div style="background-color: #f8f8f8; text-align: left;">
			<a id="btnEditToggle" class = "btn btn-sm edit-toggle" style="color:#000000;" data-toggle="collapse" data-target="#textdocument-menu" >
			  <span class="edit-toggle-off"><i class="fa fa-toggle-off fa-2x"   style="font-size: 20px; "></i> </span> 
			   <span class="edit-toggle-on"><i class="fa fa-toggle-on fa-2x"   style="font-size: 20px; "></i> </span> 
			  <span  style="font-size: 15px; margin-left:5px; vertical-align:top;">    Document Editable</span>
			</a>
			</div>
			</div>
		</div>
	</div>
	
	
    <div id="documents-ui"; style="float:left; width:100%; background-color: #f8f8f8;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<b>Documents</b><br>
			<div class="btn-group" >
			<a id="btnUpdateDoc" class="btn btn-default" href="#">
			  <i class="fa fa-pencil fa-1x"></i>
			</a>
			<a id="btnInsertDoc" class="btn btn-default" href="#">
			  <i class="fa fa-plus fa-1x"></i>
			</a>
			<a id="btnRemoveDoc" class="btn btn-default" href="#">
			  <i class="fa fa-trash fa-1x"></i>
			</a>
			</div>
			<div class="btn-group" >
			</div>
			</div>
		</div>
		 <div id="document-section" style="padding-left:2px; padding-right:2px;  text-align: left; border: 2px solid #e7e7e7;">
			<ol id="documentlist">

			</ol>
	    </div>
	</div>
	
     <div id="codesystem-ui"; style="float:left; width:100%; background-color: #f8f8f8; margin-top:5px;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<b>Code System</b><br>
			<div class="btn-group" >
			<a id="btnUpdateCode" class="btn btn-default" href="#">
			  <i class="fa fa-pencil fa-1x"></i>
			</a>
			<a id="btnInsertCode" class="btn btn-default" href="#">
			  <i class="fa fa-plus fa-1x"></i>
			</a>
			<a id="btnRemoveCode" class="btn btn-default" href="#">
			  <i class="fa fa-trash fa-1x"></i>
			</a>
			<a id="btnCodeProps" class="btn btn-default" href="#">
			  <i class="fa  fa-list-alt  fa-1x"></i>
			</a>
			</div>
			<div class="btn-group" >
			
			
			<a id="btnApplyCode" class="btn btn-default" href="#">
			<span class="fa-stack fa-lg" style= "font-size: 8px;">
			  <i class="fa fa-tag fa-stack-2x"></i>
			  <i class="fa fa-plus fa-stack-1x fa-inverse"></i>
			</span>
			</a>
			<a id="btnRemoveCoding" class="btn btn-default" href="#">
			  <span class="fa-stack fa-lg" style= "font-size: 8px;">
			  <i class="fa fa-tag fa-stack-2x"></i>
			  <i class="fa fa-minus fa-stack-1x fa-inverse"></i>
			</span>
			</a>
			</div>
			</div>
		</div>
		 <div id="easytree-section" style="padding-left:2px; padding-right:2px;  text-align: left; border: 2px solid #e7e7e7;">
			
	        <ul>
	        </ul>
	    </div>
	</div>
	<div style="float:left; width:100%; background-color: #f8f8f8; margin-top:5px;" >
	     <div style="background-color: #e7e7e7;  width:105%;">
		     <div style="text-align: center;">
			<b>Debug</b><br>
			<a id="btnShowHTML" class="btn btn-default btn-sm" href="#">
  				<i class="fa fa-file-text "></i> HTML</a>
			<div id="listCodesResult"></div>
			</div>
		</div>
	</div>
	

</div>
  <div class=col-sm-10 style="background-color: #FFF; margin-top:50px;margin-bottom:50px; height=100%;">
    
    <div id="textdocument-ui";>
    <div id="textdocument-menu"  class="collapse in" style="text-align:center; padding-top:10px;  background-color:  #e7e7e7;">
    
    
    <a id="btnTxtSave" style="float: right; margin-right: 20px;" class="btn btn-default btn-default" href="#">
  				<i class="fa fa-floppy-o "></i> Save
  	</a>
  				
    <div class="btn-group ui-widget" >
			<a id="btnTxtBold" class="btn btn-default" href="#">
			  <i class="fa fa-bold fa-1x"></i>
			</a>
			<a id="btnTxtItalic" class="btn btn-default" href="#">
			  <i class="fa fa-italic fa-1x"></i>
			</a>
			<a id="btnTxtUnderline" class="btn btn-default" href="#">
			  <i class="fa fa-underline fa-1x"></i>
			</a>
  <label>&nbsp;&nbsp;Font: </label>
  <select id="combobox">
    <option value="">Select one...</option>
    <option value="Arial">Arial</option>
    <option value="Arial Black">Arial Black</option>
    <option value="Comic Sans MS">Comic Sans MS</option>
    <option value="Courier New">Courier New</option>
    <option value="Georgia">Georgia</option>
    <option value="Impact">Impact</option>
    <option value="Lucida Console">Lucida Console</option>
    <option value="Palatino Linotype">Palatino Linotype</option>
    <option value="Tahoma">Tahoma</option>
    <option value="Times New Roman">Times New Roman</option>
    <option value="Trebuchet MS">Trebuchet MS</option>
    <option value="Verdana">Verdana</option>
  </select>
  
</div>
    <label style="margin-left:40px; ">Font Size: </label>
  <input id="txtSizeSpinner"" />
<script>
    $(function() {
        $('#txtSizeSpinner').spinner({
            min: 1,
            max: 99,
            step: 1
        });
        $('#txtSizeSpinner').width(20);
        $('#txtSizeSpinner').height(25);
    });
</script>
    </div>
		<iframe id="editor" >
		<div>
		<h1>Test Text</h1><br>
	        This test text is used to test the text for testing purposes.<br>
	        This is another test text.<br>
	        When you want to test, you can use this text.<br>
	        Test texts are a good way to test something.<br>
	        Here is some more text.<br>
	        Not done testing? More text.<br>
	        </div>
	        </iframe>
	    </div>
	    <div id="login" class="testapi">
	 <div id="login" >
       <input id="loginButton" type="button" value="Login"/>
    </div>
	
	
    </div>
</div>
</div>

<footer id="footer" class="footer">
<!-- <div style="float: right; background-color: #e7e7e7;"><i id="btnHideFooter" class="fa fa-times-circle fa-2x fa-hover" ></i> </div>  -->
<!-- float: left; -->
<div id="codeTabs" class='tab-container'>
<span style="float: right;"><i id="btnHideFooter" class="fa fa-times-circle fa-2x fa-hover" ></i> </span> 
<div class='etabs'>
    <span class='tab' id="defaultCodeTab"><a href="#codingtable">Codings</a></span>
    <span class='tab'><a href="#codeProperties">Code Properties</a></span>
    
    </div>
    
<div class='panel-container'>
<div id="codingtable" style=" text-align: center; background-color: #eee;"></div>
<div id="codeProperties" style="  background-color: #eee; ">
<table>
    <tr>
    	<td><span>Name: </span></td>
        <td><input id="codePropName" type="text" value="codePropName"></td>
    </tr>
    <tr>
    	<td><span>Author: </span></td>
        <td><input id="codePropAuthor" type="text" value="codePropAuthor"></td>
    </tr>
    <tr>
    	<td><span>Color: </span></td>
        <td><input id="codePropColor" style="width:80px;" type="text" value="#000000"></td>
    </tr>
</table>

<div style=" width: 8em; text-align: center; margin: 0 auto;">
<a id="btnCodeSave"  class="btn btn-default btn-default" href="#">
  				<i class="fa fa-floppy-o "></i> Save
  	</a>
</div>
</div>

</div>
</div>

      
 </footer>

<div id="new-code-form" title="Code Properties">
  <p class="validateTips"></p>
 
  <form >
    <fieldset>
    <table id="addCodeTable" style="padding-left: 10px;">
    <tbody>
      <tr>
        <td><label for="newCodeName">Code Name</label></td>
        <td><input type="text" name="newCodeName" id="newCodeName" value="Code Name" class="text ui-widget-content ui-corner-all"></td>
      </tr>
      <tr>
      <td>
      <label for="newCodeAuthor">Author</label>
      </td>
      <td>
      <input type="text" name="newCodeAuthor" id="newCodeAuthor" value="Author" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
      <tr>
      <td>
      <label for="newCodeID">ID</label>
      </td>
      <td>
      <input type="text" name="newCodeID" id="newCodeID" value="" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
    </tbody>
  </table>
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
<div id="update-code-form" title="Code Properties">
  <p class="validateTips"></p>
 
  <form >
    <fieldset>
    <table id="changeCodeTable" style="padding-left: 10px;">
    <tbody>
   	  <tr>
      <td>
      <label for="updateCodeID">ID</label>
      </td>
      <td>
      <div id="updateFormCodeId"></div>
      </td>
      </tr>
      <tr>
        <td><label for="updateCodeName">Code Name</label></td>
        <td><input type="text" name="updateCodeName" id="updateCodeName" value="Code Name" class="text ui-widget-content ui-corner-all"></td>
      </tr>
      <tr>
      <td>
      <label for="updateCodeAuthor">Author</label>
      </td>
      <td>
      <input type="text" name="updateCodeAuthor" id="updateCodeAuthor" value="Author" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
      
    </tbody>
  </table>
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
<div id="debugTextEditor" title="HTML">
  
</div>


  <script>
  (function( $ ) {
    $.widget( "custom.combobox", {
      _create: function() {
        this.wrapper = $( "<span>" )
          .addClass( "custom-combobox" )
          .insertAfter( this.element );
 
        this.element.hide();
        this._createAutocomplete();
        this._createShowAllButton();
      },
 
      _createAutocomplete: function() {
        var selected = this.element.children( ":selected" ),
          value = selected.val() ? selected.text() :  " ";
 
        this.input = $( "<input>" )
          .appendTo( this.wrapper )
          .val( value )
          .attr( "title", "" )
          .addClass( "custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left" )
          .autocomplete({
            delay: 0,
            minLength: 0,
            source: $.proxy( this, "_source" )
          })
          .tooltip({"trigger":"manual"});
 
        this._on( this.input, {
          autocompleteselect: function( event, ui ) {
            ui.item.option.selected = true;
            this._trigger( "select", event, {
              item: ui.item.option
            });
            editor['setFontFace'](ui.item.option.innerHTML);
          },
 
          autocompletechange: "_removeIfInvalid"
        });
      },
 
      _createShowAllButton: function() {
        var input = this.input,
          wasOpen = false;
 
        $( "<a>" )
          .attr( "tabIndex", -1 )
          .attr( "title", "Show All Items" )
          .appendTo( this.wrapper )
          .button({
            icons: {
              primary: "ui-icon-triangle-1-s"
            },
            text: false
          })
          .removeClass( "ui-corner-all" )
          .addClass( "custom-combobox-toggle ui-corner-right" )
          .mousedown(function() {
            wasOpen = input.autocomplete( "widget" ).is( ":visible" );
          })
          .click(function() {
            input.focus();
 
            // Close if already visible
            if ( wasOpen ) {
              return;
            }
 
            // Pass empty string as value to search for, displaying all results
            input.autocomplete( "search", "" );
          });
      },
 
      _source: function( request, response ) {
        var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
        response( this.element.children( "option" ).map(function() {
          var text = $( this ).text();
          if ( this.value && ( !request.term || matcher.test(text) ) )
            return {
              label: text,
              value: text,
              option: this
            };
        }) );
      },
 
      _removeIfInvalid: function( event, ui ) {
 
        // Selected an item, nothing to do
        if ( ui.item ) {
          return;
        }
 
        // Search for a match (case-insensitive)
        var value = this.input.val(),
          valueLowerCase = value.toLowerCase(),
          valid = false;
        this.element.children( "option" ).each(function() {
          if ( $( this ).text().toLowerCase() === valueLowerCase ) {
            this.selected = valid = true;
            return false;
          }
        });
 
        // Found a match, nothing to do
        if ( valid ) {
          return;
        }
 
        // Remove invalid value
        this.input
          .val( "" )
          .tooltip("set","content", value +  " is not supported")
          .tooltip( "show" );
        this.element.val( "" );
        this._delay(function() {
          this.input.tooltip( "hide" );
        }, 2500 );
        this.input.autocomplete( "instance" ).term = "";
      },
 
      _destroy: function() {
        this.wrapper.remove();
        this.element.show();
      }
    });
  })( jQuery );
 
  $(function() {
    $( "#combobox" ).combobox();
    $( "#toggle" ).click(function() {
      $( "#combobox" ).toggle();
    });
  });
  </script>
<script type="text/template" id="editorStyles">
  html {
    height: 100%;
  }
  body {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    height: 100%;
    padding: 1em;
    background: transparent;
    color: #2b2b2b;
    font: 13px/1.35 Helvetica, arial, sans-serif;
    cursor: text;
  }
  a {
    text-decoration: underline;
  }
  h1 {
    font-size: 138.5%;
  }
  h2 {
    font-size: 123.1%;
  }
  h3 {
    font-size: 108%;
  }
  h1,h2,h3,p {
    margin: 1em 0;
  }
  h4,h5,h6 {
    margin: 0;
  }
  ul, ol {
    margin: 0 1em;
    padding: 0 1em;
  }
  blockquote {
    border-left: 2px solid blue;
    margin: 0;
    padding: 0 10px;
  }
</script>



<script src="https://apis.google.com/js/platform.js?onload=onLoad" async defer></script>
<script src="assets/js/ErrorHandler.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">

          
	    var scopes = 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
	    var client_id = '309419937441-6d41vclqvedjptnel95i2hs4hu75u4v7.apps.googleusercontent.com';
	    var current_user_name;
	    var current_user_id;
	    var codesystem_id;
	    var active_code;
	    var active_document = {};
	    var text_documents = {};
	    var project_id;
	    var documentMap;
	    var max_coding_id;
	    
	    var editor;
	    var iframe = document.getElementById( 'editor' );
	    $(document).ready( function () {
	      // Make sure we're in standards mode.
	      var doc = iframe.contentDocument;
	      $("iframe").css({  height : $(window).height() -52});
	      if ( doc.compatMode !== 'CSS1Compat' ) {
	          doc.open();
	          doc.write( '<!DOCTYPE html><title></title>' );
	          doc.close();
	      }
	      
	      doc.open();
          doc.write( '<!DOCTYPE html><title>test</title><head></head>' );
          doc.close();
	      // doc.close() can cause a re-entrant load event in some browsers,
	      // such as IE9.
	      if ( editor ) {
	          return;
	      }
	      // Create Squire instance
	      editor = new Squire( doc, {
	          blockTag: 'p',
	          blockAttributes: {'class': 'paragraph'},
	          tagAttributes: {
	              ul: {'class': 'UL'},
	              ol: {'class': 'OL'},
	              li: {'class': 'listItem'}
	          }
	      });
	      editor['readOnly']('true');

	   // Add styles to frame
	      var style = doc.createElement( 'style' );
	      style.type = 'text/css';
	      style.textContent = document.getElementById( 'editorStyles' ).textContent;
	      doc.querySelector( 'head' ).appendChild( style );
	      
	      
	      //$( "#codeTabs" ).tabs();
	      $("#codeTabs").easytabs({
	    	  animate: true,
	    	  animationSpeed: 100,
	    	  panelActiveClass: "active-content-div",
	    	  defaultTab: "span#defaultCodeTab",
	    	  tabs: "> div > span",
	    	  updateHash: false
	    	});
	      
	      $('.tooltips').tooltipster();
	      
	        //documents-ui
	        $('#btnUpdateDoc').tooltipster({
	            content: $('<span>Rename Document</span>'),
	        });
	        
	        $('#btnInsertDoc').tooltipster({
	            content: $('<span>New Document</span>'),
	        });
	        
	        $('#btnRemoveDoc').tooltipster({
	            content: $('<span>Remove Document</span>'),
	        });
	        
	        
	        //codesystem-ui
	        $('#btnApplyCode').tooltipster({
	            content: $('<span>Apply Code</span>'),
	        });
	        
	        $('#btnRemoveCoding').tooltipster({
	            content: $('<span>Remove Coding</span>'),
	        });
	        
	        $('#btnCodeProps').tooltipster({
	            content: $('<span>Code Properties</span>')
	        });
	        
	        $('#btnRemoveCode').tooltipster({
	            content: $('<span>Delete Code</span>')
	        });
	        
	        $('#btnInsertCode').tooltipster({
	            content: $('<span>New Code</span>')
	        });
	        
	        $('#btnUpdateCode').tooltipster({
	            content: $('<span>Edit Code</span>')
	        });
	        
	        
	        $("#codePropColor").colorpicker();
	    });
	        
	    
	    window.onresize = resizeHandler;
	    
	    function resizeHandler(){
	  	      setTimeout(function() {
	  	    	resizeElements();
	  	    }, 250);
	  	      if ($(window).width() > 770 || $(window).height() > 600){
	  	    	$.LoadingOverlay("hide");
	  	      }
	    }
	    
	    function resizeElements(){
	    	if ($(window).width() < 770 || $(window).height() < 600){
	    		$.LoadingOverlay("show_resize");
	    	}
	    	else
	    		{
	    		$.LoadingOverlay("hide");
	    		}
	    	var offsetHeight = 0;
	    	if ($("#footer").is(":visible")){
	    		offsetHeight += 341;
			} 
	    	if ($("#textdocument-menu").is(":visible")){
	    		offsetHeight += 45;
			} 
	    	$("iframe").css({  height : $(window).height() -52 - offsetHeight});
	    }
	    
	    var easytree = $('#easytree-section').easytree({
            enableDnd: true,
            dropped: dropped,
            stateChanged: codesystemStateChanged
        });
	    
	    function handleAuth() {

	    	
		  var request = gapi.client.oauth2.userinfo.get().execute(function(resp) {
		    if (!resp.code) {
		      // User is signed in, so hide the button
		      document.getElementById('loginButton').style.visibility = 'hidden';
		      document.getElementById('login').innerText = 'Welcome ' + resp.name;
		      current_user_name = resp.given_name;
		      current_user_id = resp.id;
		      //window.alert(resp.id);
		      document.getElementById('currentUserName').innerHTML = resp.name;
		      document.getElementById('currentUserEmail').innerHTML = resp.email;
		      document.getElementById('currentUserPicture').src = resp.picture;
		      $('#navAccount').show();
		      $('#navSignin').hide();
		      
		      // INIT
		      
		      gapi.client.qdacity.project.getProject({'id': project_id}).execute(function(resp) {
     	    	 if (!resp.code) {
     	    		 codesystem_id = resp.codesystemID;
	        	    	 setDocumentList(project_id);
	        	    	 listCodes();
     	    	 }
     	    	 else{
     	    		handleError(resp.code);
     	    	}
     	    	 $.LoadingOverlay("hide");
     	    	 
     	     });
		      
		    }
		    else {
		    	document.getElementById('loginButton').style.visibility = '';
		    	 $('#navAccount').hide();
		    	 handleError(resp.code);
		    }
		  });
		}
	    
	    function signin(mode, callback) {
	    	  gapi.auth.authorize({client_id: client_id,scope: scopes, immediate: mode},callback);
	    }
	    
	    function signout(){
	    	window.open("https://accounts.google.com/logout");
	    }
    
        function init() {
        	
        	$.LoadingOverlay("show");
        	$( "#footer" ).hide();
        	$('#navAccount').hide();
        	$( "#textdocument-menu" ).collapse(); // editor will be initialized readonly, the toggle is later hooked to the visibility of the toolbar
        	
        	
        	
        	
        	var query = window.location.search;
        	  // Skip the leading ?, which should always be there,
        	  // but be careful anyway
        	  if (query.substring(0, 1) == '?') {
        	    query = query.substring(1);
        	  }
        	  var data = query.split(',');
        	  for (i = 0; (i < data.length); i++) {
        	    data[i] = unescape(data[i]);
        	  }
        	  project_id = data[0];
        	  
        	var apisToLoad;
        	 var callback = function() {
        	   if (--apisToLoad == 0) {
        		   signin(true,handleAuth);
        	     //Load project settings
        	     
        	   }
        	   
        	}
        	  
        	apisToLoad = 2;
        	//Parameters are APIName,APIVersion,CallBack function,API Root 
        	//gapi.client.load('qdacity', 'v1', callback, 'https://localhost:8888/_ah/api');
        	gapi.client.load('qdacity', 'v1', callback, 'https://qdacity-app.appspot.com/_ah/api');
        	gapi.client.load('oauth2','v2',callback);
        	
        	                
                document.getElementById('btnCodeProps').onclick = function(){
                	if ($("#footer").is(":visible")){
                		hideCodingView();
    				} 
                	else {
                		showCodingView();
                	}
                }
                
                
                
                document.getElementById('btnRemoveCode').onclick = function() {
                    deleteCode();
                }
                
                document.getElementById('btnInsertDoc').onclick = function() {
                	addDocumentToProject();
            	}  
                
                document.getElementById('btnRemoveDoc').onclick = function() {
                	removeDocumentFromProject();
            	}  
                
                document.getElementById('btnUpdateDoc').onclick = function() {
                	changeDocumentTitle();
            	}  
                
                
                document.getElementById('loginButton').onclick = function() {
            		signin(false,handleAuth);
            	}  
                
                document.getElementById('btnHideFooter').onclick = function() {
                	hideCodingView();
            	}  
                
                document.getElementById('btnApplyCode').onclick = function() {
                	var activeID = getActiveCode().id;
                	if (typeof activeID != 'undefined'){
                		gapi.client.qdacity.project.incrCodingId({'id': project_id}).execute(function(resp){
                			var codingID = resp.maxCodingID;
                			var author = current_user_name;	
                			editor['setCoding'](codingID, activeID, getActiveCode().name, author);
                			saveEditorContent();
                			easytree.getNode(activeID).codingCount--;
                			easytree.rebuildTree();
                			
                		});
                		
                	}
                  }
                
                document.getElementById('btnRemoveCoding').onclick = function() {
                	var activeID = getActiveCode().id;
                	if (typeof activeID != 'undefined'){
                		
                		editor['removeCoding'](activeID);
                		easytree.getNode(activeID).codingCount++;
            			easytree.rebuildTree();
            			saveEditorContent();
                	}
                	else{
                		window.alert("No code selected.")
                	}
                	
            	}  
                
                document.getElementById('btnCodeSave').onclick = function() {
                	updateCode($('#codePropAuthor').val(),$('#codePropName').val(), $('#codePropColor').val() ,getActiveCode().id);
                	
            	} 
                
 				document.getElementById('navBtnSigninGoogle').onclick = function() {
 					signin(false, handleAuth);
            	}  
 				
 				document.getElementById('navBtnSignOut').onclick = function() {
 					signout();
            	}  
                
 				document.getElementById('btnShowHTML').onclick = function() {
 					/* document.getElementById('listCodesResult').innerHTML = "<span  data-placement=\"top\" data-content=\"Tooltip title\" data-trigger=\"hover\">test</span>"
 					$('#listCodesResult').tooltip({"content":"Demo tooltip"}); */
 					
 					 $( "#debugTextEditor" ).dialog();
 					document.getElementById('debugTextEditor').innerHTML = "<xmp>" + editor.getHTML() + "</xmp>";
 					$( "#debugTextEditor" ).dialog( "option", "show", { effect: "blind", duration: 800 } ); 
            	}  
				
 				document.getElementById('btnTxtBold').onclick = function() {
 					editor['bold']();
            	}
 				
 				document.getElementById('btnTxtItalic').onclick = function() {
 					editor['italic']();
            	}
 				
 				document.getElementById('btnTxtUnderline').onclick = function() {
 					editor['underline']();
            	}
 				
 				document.getElementById('btnTxtSave').onclick = function() {
 					saveEditorContent();
            	}
 				
 				$("#txtSizeSpinner").on( "spin", function( event, ui ) { 
 					editor['setFontSize'](ui.value);
 				});
 				
 				$('#textdocument-menu').on('shown.bs.collapse', function () {
 					editor['readOnly']('false');
 					resizeElements();
 				})
 				
 				$('#textdocument-menu').on('hidden.bs.collapse', function () {
 					editor['readOnly']('true');
 					resizeElements();
 				})
 				
        }
        
        function showCodingView(){
        	showFooter();
        	var activeID = getActiveCode().id;
        	fillCodingTable(activeID);
        	fillPropertiesView(activeID);
        	resizeHandler();
        }
        
        function showFooter(){
        	$( "#footer" ).show( "clip", {}, 200, resizeElements );
        }
        
        function hideCodingView(){
        	$( "#footer" ).hide( "clip", {}, 200, resizeElements );
        	
        }
        
        function fillCodingTable(codeID){
        	var table = $('#example').DataTable();
        	
        	table.clear();
        	
        	var codings = [];
        	
        	table.clear();
        	for (var id in text_documents){
        		var elements = text_documents[id].text;
	    			var found = $('coding', elements);
	    			var foundArray = $('coding[code_id=\''+codeID+'\']', elements).map(function() {
	    				var tmp = {};
	    				tmp.id = $(this).attr('id');
	    				tmp.code_id = $(this).attr('code_id');
	    				tmp.author = $(this).attr('author');
	                  return tmp;
	                  
	              });
	    			foundArray = foundArray.toArray();
					var idsAdded = []; // When a coding spans multiple HTML blocks, then there will be multiple elements with the same ID
	    			for (var j=0;j<foundArray.length;j++) {
	    				if ($.inArray(foundArray[j].id, idsAdded) != -1) continue;
	    			  	table.row.add( [ foundArray[j].id, text_documents[id].title, foundArray[j].author] );
	    			  	idsAdded.push(foundArray[j].id);
	    			}
	    			  
        	}
        	
        	table.draw();
        }
        
        function fillPropertiesView(codeID){
        	$("#codePropName").val(getActiveCode().name);
        	$("#codePropAuthor").val(getActiveCode().author);
        	//$("#codePropColor").val(getActiveCode().color);
        	$("#codePropColor").colorpicker({
        		color : getActiveCode().color
        	});
        }
        
        function getCodingCount(codeId){
        	
        }
        
        function setDocumentList(projectID){
        	$("#documents-ui").LoadingOverlay("show");
        	gapi.client.qdacity.documents.getTextDocument({'id': project_id}).execute(function(resp){
	    		 if (!resp.code) {
	    			resp.items = resp.items || [];
   	    		for (var i=0;i<resp.items.length;i++) {
   	    			addDocumentToList(resp.items[i].id, resp.items[i].title);
   	    			var document = {};
   	    			document.id = resp.items[i].id;
   	    			document.title = resp.items[i].title;
   	    			document.text = resp.items[i].text.value;
   	    			text_documents[document.id] = document;
               	}
	    		 }
	    		 
	    		 $("#documents-ui").LoadingOverlay("hide");
	    		 
	    		 // Extract the codings from the loaded documents
	    		 addCodingCountToTree();
	    		 
	    	 });
        }
        
        function addDocumentToProject(){
        	var title = prompt("Name the document", "Title");

        	if (title == null) {
        	    return;
        	}
        	var requestData = {};
            requestData.projectID = project_id;
            requestData.text = " "; // can not be empty
            requestData.title = title;
            
            gapi.client.qdacity.documents.insertTextDocument(requestData).execute(function(resp) {
                    if (!resp.code) {
                    	document.getElementById('documentlist').innerHTML = "";
                    	setDocumentList(project_id);
                    }
            });
                
        }
        
        function removeDocumentFromProject(){
        	var ids = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	
        	ids = ids.toArray();
        	for (var i=0;i<ids.length;i++) {
        		var requestData = {};
        		requestData.id = ids[i];
                gapi.client.qdacity.documents.removeTextDocument(requestData).execute(function(resp) {
                	document.getElementById('documentlist').innerHTML = "";
                	setDocumentList(project_id);   
                })
        	}
        }
        
        function changeDocumentTitle(){
        	var ids = $('#documentlist .ui-selected').map(function() {
                return $(this).attr('docID');
                
            });
        	ids = ids.toArray();
        	var title = prompt("New name for document \"" + ids[0] + "\"", "Title");
        	changeDocumentData(ids[0], title);
        }
        
        function changeDocumentData(id, title){
        	
        		var requestData = {};
        		requestData.id = id;
        		requestData.title = title;
        		requestData.text = editor.getHTML();
        		requestData.projectID = project_id;
        		//FIXME text
                gapi.client.qdacity.documents.updateTextDocument(requestData).execute(function(resp) {
                	document.getElementById('documentlist').innerHTML = "";
                	setDocumentList(project_id);   
                });
        }
        
        function setDocumentView(textDocumentID){
			if (typeof text_documents[textDocumentID].text  == 'undefined'){
				editor.setHTML("");
			}
			else{
				editor.setHTML(text_documents[textDocumentID].text);
				addTooltipsToEditor(textDocumentID);
			}
        }
        
        //List Codes function that will execute the listCode call
        function listCodes() {
        	$("#codesystem-ui").LoadingOverlay("show");
        	var codes = [];
                gapi.client.qdacity.codesystem.getCodeSystem({'id': codesystem_id}).execute(function(resp) {
                        if (!resp.code) {
                                resp.items = resp.items || [];
                                var result = "";
                                
                                for (var i=0;i<resp.items.length;i++) {
                                        result = result+ resp.items[i].name + "..." + "<b>" + resp.items[i].author + "</b>" + "[" + resp.items[i].id + "]" + "   {" + resp.items[i].subCodesIDs + "}" + "<br/>";
                                        
                                        codes.push(resp.items[i]);
                                }
                                document.getElementById('listCodesResult').innerHTML = result;
                                for(var i=0;i<codes.length;i++) {
                                	addNodeToTree(codes[i].id, codes[i].name, codes[i].author, codes[i].color, codes[i].parentID, codes[i].subCodesIDs);
                                }
                                
                                for(var i=0;i<codes.length;i++) {
                                	if (typeof codes[i].subCodesIDs != 'undefined')
                                	{
	                                	if (codes[i].subCodesIDs.length > 0){
	                                		
		                                	for(var j=0;j<codes.length;j++) {
		                                		for(var k=0; k < codes[i].subCodesIDs.length; k++){
		                                			if (codes[i].subCodesIDs[k] == codes[j].id){
		                                				relocateNode(codes[j].id, codes[i].id);
		                                			}
		                                		}
		                                	}
		                                	
	                                    }
                                	}
                                }
                        }
                        addCodingCountToTree();
                        $("#codesystem-ui").LoadingOverlay("hide");
                });
        }
        
     
        
        

        //Insert Code function
        function insertCode(_AuthorName, _CodeName, _ID) {
        	var activeID = getActiveCode().id;
                //Build the Request Object
                var requestData = {};
                requestData.author = _AuthorName;
                requestData.name = _CodeName;
                requestData.id = _ID;
                requestData.subCodesIDs = new Array();
                requestData.parentID = activeID;
                requestData.codesytemID = codesystem_id;
                requestData.color = "#000000";
                
                gapi.client.qdacity.codes.insertCode(requestData).execute(function(resp) {

                	console.log(resp.id + ":" + resp.author + ":" + resp.name);
                        if (!resp.code) {
                                //Just logging to console now, you can do your check here/display message
                                console.log(resp.id + ":" + resp.author + ":" + resp.name);
                                document.getElementById('listCodesResult').innerHTML = resp.id + ":" + resp.author + ":" + resp.name;
                                addNodeToTree(resp.id, resp.name, resp.author, resp.color, resp.parentID, resp.subCodesIDs);
                                if (typeof activeID != 'undefined'){
                                	addSubCode(activeID, _ID);
                                	relocateNode(_ID, activeID);
                                }
                        }
                });
        }
        
        //Update Code function
        function updateCode(_AuthorName, _CodeName, _CodeColor, _ID) {
                //Build the Request Object
                var requestData = {};
                requestData.id = _ID;
                requestData.author = _AuthorName;
                requestData.name = _CodeName;
                requestData.color = _CodeColor;
                requestData.codesytemID = codesystem_id;
                requestData.parentID = getActiveCode().parentID;
                requestData.subCodesIDs = getActiveCode().subCodesIDs;
                gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
                        if (!resp.code) {
                                //Just logging to console now, you can do your check here/display message
                                console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
                                updateNode(resp.id, resp.name, resp.author, resp.color);
                        }
                });
        }
        
        
        
        function relocateCode(codeId, newParentId){
        	removeLinkFromOldParent(codeId);
        	
        	addSubCode(newParentId, codeId);
        	
        	changeParentId(codeId, newParentId);
        }
        
        //Add SubCode function FIXME
        function addSubCode(_ID, _SubID) {
            //var _ID = document.getElementById("parentCodeID").value;
            //var _SubID = document.getElementById("childCodeID").value;
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	          
            	          var code = {};
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            requestData.codesytemID = resp.codesytemID;
            	            requestData.color = resp.color;
            	            if (typeof resp.subCodesIDs == 'undefined'){
            	            	 requestData.subCodesIDs = [_SubID];
            	            }
            	            else {
            	            	requestData.subCodesIDs = resp.subCodesIDs.concat(_SubID);
            	            }
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    	//relocateNode(_SubID, _ID);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function changeParentId(_ID, _newParent) {
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            requestData.subCodesIDs = resp.subCodesIDs;
            	            requestData.parentID = _newParent;
            	            requestData.codesytemID = resp.codesytemID;
            	            requestData.color = resp.color;
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function removeSubCode(_ID, _SubID) {
            //Validate the entries
           // var _ID = document.getElementById("parentCodeID").value;
           // var _SubID = document.getElementById("childCodeID").value;
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	          
            	          var code = {};
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            requestData.codesystemID = resp.codesystemID;
            	            requestData.color = resp.color;
            	            for(var i = resp.subCodesIDs.length - 1; i >= 0; i--) {
            	            	
            	                if(resp.subCodesIDs[i] === _SubID) {
            	                	
            	                	resp.subCodesIDs.splice(i, 1);
            	                }
            	            }
            	            requestData.subCodesIDs = resp.subCodesIDs;
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                            //Just logging to console now, you can do your check here/display message
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function removeLinkFromOldParent(codeId) {

            gapi.client.qdacity.codes.getCode({'id': codeId}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
	            	          	if (typeof resp.parentID != 'undefined'){
	            	          		removeSubCode(resp.parentID, codeId);
	            	          	}
            	          }
        	 });
    	}
        
        
        
        //Delete code function
        function deleteCode() {
        	var activeID = getActiveCode().id;
        	if (typeof activeID == 'undefined'){
        		window.alert("No code selected");
        		return;
        	}
        	else
       		{
	            //Build the Request Object
	            var requestData = {};
	            requestData.id = activeID;
	            console.log(requestData);
	            gapi.client.qdacity.codes.removeCode(requestData).execute(function(resp) {
	                    //Just logging to console now, you can do your check here/display message
	                    console.log(resp);
	                    removeNodeFromTree(activeID);
	            });
       		}
                
        }
        
        function setNameAndAuthor(codeId, nameField, authorField){
        	gapi.client.qdacity.codes.getCode({'id': codeId}).execute(function(resp) {
            	
  	          if (!resp.code) {
  	        	document.getElementById(nameField).value = resp.name;
  	        	document.getElementById(authorField).value = resp.author;
  	          }  	          
	 });
        }
        
        $(function() {
        
            var dialog, form,
            name = $( "#newCodeName" ),
            email = $( "#newCodeAuthor" ),
            password = $( "#newCodeID" ),
            allFields = $( [] ).add( name ).add( email ).add( password ),
              tips = $( ".validateTips" );
         
         
            function addCode() {
            	var name = document.getElementById('newCodeName').value,
                author = document.getElementById('newCodeAuthor').value,
                id = document.getElementById("newCodeID" ).value;

              insertCode(author,name,id);
              dialog.dialog( "close" );
              form[ 0 ].reset();
            }
         
            dialog = $( "#new-code-form" ).dialog({
              autoOpen: false,
              height: 350,
              width: 450,
              modal: true,
              buttons: {
                "Add code": addCode,
                Cancel: function() {
                  dialog.dialog( "close" );
                }
              },
              close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
                
              }
            });
         
            form = dialog.find( "form" ).on( "submit", function( event ) {
              event.preventDefault();
              addCode();
            });
         
            $( "#btnInsertCode" ).on( "click", function() {
            	$('#newCodeAuthor').attr('value', current_user_name) ;
              dialog.dialog( "open" );
            });
            
          });
        
        //FIXME check for dead legacy code
        $(function() {
            var dialog, form,
            name = $( "#updateCodeName" ),
            email = $( "#updateCodeAuthor" ),
            password = $( "#updateCodeID" ),
            allFields = $( [] ).add( name ).add( email ).add( password ),
              tips = $( ".validateTips" );
         
         
            function changeCode() {
            	var name = document.getElementById('updateCodeName').value,
                author = document.getElementById('updateCodeAuthor').value,
                id = getActiveCode().id;

              updateCode(author,name, "#000000",id);
              dialog.dialog( "close" );
              form[ 0 ].reset();
            }
         
            dialog = $( "#update-code-form" ).dialog({
              autoOpen: false,
              height: 350,
              width: 450,
              modal: true,
              buttons: {
                "Modify code": changeCode,
                Cancel: function() {
                  dialog.dialog( "close" );
                }
              },
              close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
                
              }
            });
         
            form = dialog.find( "form" ).on( "submit", function( event ) {
              event.preventDefault();
              changeCode();
            });
         
            $( "#btnUpdateCode" ).on( "click", function() {
              document.getElementById('updateFormCodeId').innerHTML = getActiveCode().id;
              setNameAndAuthor( getActiveCode().id, 'updateCodeName', 'updateCodeAuthor');
              dialog.dialog( "open" );
            });
          });
        
        function addNodeToTree(id, name, author, color, parentID, subCodesIDs) {
			var sourceNode = {};
            sourceNode.text = name;
            sourceNode.isFolder = true;
            sourceNode.id = id;
            sourceNode.codingCount = 0;
            sourceNode.uiIcon = "fa-tag fa-lg";
            sourceNode.author = author;
            sourceNode.color = color;
            sourceNode.parentID = parentID;
            sourceNode.subCodesIDs = subCodesIDs;
           
           sourceNode.onclick = function() {
        	   window.alert("test");
           }
			
            easytree.addNode(sourceNode);
            easytree.rebuildTree();
        }
        
        function addCodingCountToTree(){
        	
        	var nodes = easytree.getAllNodes();
			 var codeIDs = getAllCodeIds(nodes);
			 
			for (var i = 0;  i < codeIDs.length; i++) {
   			var codingCount = 0;
	    		for (var id in text_documents) {
	    			var elements = text_documents[id].text;
	    			var foundArray = $('coding[code_id=\''+codeIDs[i]+'\']', elements).map(function() {
	                  return $(this).attr('id');
	              	});
	    			var idsCounted = []; // When a coding spans multiple HTML blocks, then there will be multiple elements with the same ID
	    			for (var j=0;j<foundArray.length;j++) {
	    				if ($.inArray(foundArray[j], idsCounted) != -1) continue;
	    				codingCount++;
	    			  	idsCounted.push(foundArray[j]);
	    			}
          		}
	    		var node = easytree.getNode(codeIDs[i]);
	    		
	    		node.codingCount = codingCount;
			}
			 easytree.rebuildTree();           
        }
        
        function removeNodeFromTree(id) {
            
            easytree.removeNode(id);
            easytree.rebuildTree();
        }
        
        function relocateNode(id, target) {
        	
            var sourceNode = easytree.getNode(id);
            sourceNode.isFolder = true;
            var targetId = target;
            easytree.removeNode(id);
			
            easytree.addNode(sourceNode, target);
            easytree.rebuildTree();
        }
        
		function updateNode(id, name, author, color) {
        	
            var sourceNode = easytree.getNode(id);
            sourceNode.text = name;
            sourceNode.author = author;
            sourceNode.color = color;

            easytree.rebuildTree();
        }
		
		function getActiveCode() {
            var nodes = easytree.getAllNodes();
            var activeNode =  getActiveNodeRecursive (nodes);
            
            var code = {};
            if (typeof activeNode == 'undefined'){
            	code.id = 'undefined';
            	code.name = 'undefined';
            	code.author = 'undefined';
            	code.color = 'undefined';
            }
            else{
            	code.id = activeNode.id;
                code.name = activeNode.text;
                
                code.author = activeNode.author;
                code.color = activeNode.color;
                code.parentID = activeNode.parentID;
                code.subCodesIDs = activeNode.subCodesIDs;
            }
            return code;
            
        }
		
		function getActiveNodeRecursive(nodes) {
			for (var i = 0;  i < nodes.length; i++) {
            	if (nodes[i].isActive == true){
            		return nodes[i];
            	}
            	if (nodes[i].children && nodes[i].children.length > 0) {
                    var result = getActiveNodeRecursive(nodes[i].children);
                    if (typeof result != 'undefined') return result;
                }
            }
        }
		
		function getAllCodeIds(nodes) {
			var ids = [];
			for (var i = 0;  i < nodes.length; i++) {
            	ids.push(nodes[i].id);
            	if (nodes[i].children && nodes[i].children.length > 0) {
            		
                    var result = getAllCodeIds(nodes[i].children);
                    ids = ids.concat(result);
                }
            }
			return ids;
        }
		
		
		
		function dropped(event, nodes, isSourceNode, source, isTargetNode, target) {
			
            if (isSourceNode && isTargetNode) { // internal to internal drop
            	relocateCode(source.id, target.id);
            }
        }
		
		var initialized_easytree = false;
		function codesystemStateChanged(nodes, nodesJson) {
			if (initialized_easytree){
			active_code = getActiveCode().id;
				if ($("#footer").is(":visible")){
					fillCodingTable(active_code);
					fillPropertiesView(active_code);
				} 
			}
			else{
				initialized_easytree = true;
			}
	    }
		
		var listCreated = false;
        
		
        function addDocumentToList(docID, newItem){
        	//window.alert("<li class=\"ui-widget-content\" data-docID=\""+ docID +"\">" + newItem + "</li>");
            $("#documentlist").append("<li class=\"ui-widget-content\" docID=\""+ docID +"\">" + newItem + "</li>");
            //$("#documentlist").listview("refresh");
            
        }
		  
    </script>
    <script src="https://apis.google.com/js/client.js?onload=init"></script>
</body>
</html>
