<!DOCTYPE html>
<html lang="en">
<html>
<head>

	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>QDAcity API Test</title>
     <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="css/landing-page.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <!-- EasyTree -->
	<link rel="stylesheet" type="text/css" href="EasyTree/skin-win8/ui.easytree.css">
	<script type="text/javascript" src="EasyTree/jquery.easytree.min.js"></script>
    
   
    
    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
    
      
      
        <style>
    .validateTips { border: 1px solid transparent; padding: 0.3em; }
  </style>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
</head>
<body>
<div class="row">
<div class=col-md-12 >
<!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top topnav" role="navigation">
        <div class="container topnav">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand topnav" href="index.html">QDAcity</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="index.html#about">About</a>
                    </li>
                    <li>
                        <a href="apitest.html">API Test</a>
                    </li>
                    <li>
                        <a href="index.html#contact">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>

        <!-- /.container -->
    </nav>
            </div>
            </div>
    <div class=row style="background-color: #f8f8f8">
    <div class=col-md-2 >
     <div style="float:left; width:103%; margin-left:2px; margin-right:2px; margin-top:50px; text-align: left; border: 2px solid #e7e7e7; ">
     <div style="background-color: #e7e7e7; ">
     <div style="text-align: center;">
<b>Code System</b><br>
<div class="btn-group">
<a id="btnUpdateCode" class="btn btn-default" href="#">
  <i class="fa fa-pencil fa-1x"></i>
</a>
<a id="btnInsertCode" class="btn btn-default" href="#">
  <i class="fa fa-plus fa-1x"></i>
</a>
<a class="btn btn-default" href="#">
  <i class="fa fa-trash fa-1x"></i>
</a>
<a id="btnListCode" class="btn btn-default" href="#">
  <i class="fa fa-refresh fa-1x"></i>
</a>
</div>
</div>
</div>
    <div id="easytree-section" ">
	
        <ul>
        </ul>
    </div>
</div>

</div>
    <div class=col-md-10 style="background-color: #FFF" >
    <div id="login" class="testapi">
	 <div id="login" >
       <input id="loginButton" type="button" value="Login"/>
    </div>
    <div id="listCodesResult"></div>
    
    <form id="linkageForm" action="javascript:void(0);">
      <h2>Add/Remove Linkage</h2>
         <div><input id="parentCodeID" placeholder="Parent ID value"></input></div>
         <div><input id="childCodeID" placeholder="Child ID value"></input></div>
         <div><input id="addSubCode" type="submit" value="Add Subcode"><input id="removeSubCode" type="submit" value="Remove Subcode"></div>
    </form>
    
    
    <form id="deleteCodeForm" action="javascript:void(0);">
      <h2>Delete Code</h2>
         <div><input id="codeID" placeholder="Code ID"></input></div>
         <div><input id="deleteCode" type="submit" value="Delete Code"></div>
    </form>
    </div>
</div>
</div>
<div id="new-code-form" title="Code Properties">
  <p class="validateTips"></p>
 
  <form >
    <fieldset>
    <table id="addCodeTable" style="padding-left: 10px;">
    <tbody>
      <tr>
        <td><label for="newCodeName">Code Name</label></td>
        <td><input type="text" name="newCodeName" id="newCodeName" value="Code Name" class="text ui-widget-content ui-corner-all"></td>
      </tr>
      <tr>
      <td>
      <label for="newCodeAuthor">Author</label>
      </td>
      <td>
      <input type="text" name="newCodeAuthor" id="newCodeAuthor" value="Author" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
      <tr>
      <td>
      <label for="newCodeID">ID</label>
      </td>
      <td>
      <input type="text" name="newCodeID" id="newCodeID" value="" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
    </tbody>
  </table>
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
<div id="update-code-form" title="Code Properties">
  <p class="validateTips"></p>
 
  <form >
    <fieldset>
    <table id="changeCodeTable" style="padding-left: 10px;">
    <tbody>
      <tr>
        <td><label for="updateCodeName">Code Name</label></td>
        <td><input type="text" name="updateCodeName" id="updateCodeName" value="Code Name" class="text ui-widget-content ui-corner-all"></td>
      </tr>
      <tr>
      <td>
      <label for="updateCodeAuthor">Author</label>
      </td>
      <td>
      <input type="text" name="updateCodeAuthor" id="updateCodeAuthor" value="Author" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
      <tr>
      <td>
      <label for="updateCodeID">ID</label>
      </td>
      <td>
      <input type="text" name="updateCodeID" id="updateCodeID" value="" class="text ui-widget-content ui-corner-all">
      </td>
      </tr>
    </tbody>
  </table>
      <!-- Allow form submission with keyboard without duplicating the dialog button -->
      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
    </fieldset>
  </form>
</div>
    <script type="text/javascript">

          
	    var scopes = 'https://www.googleapis.com/auth/userinfo.email';
	    var client_id = '309419937441-6d41vclqvedjptnel95i2hs4hu75u4v7.apps.googleusercontent.com';
	    
	    var easytree = $('#easytree-section').easytree();
	    function handleAuth() {
		  var request = gapi.client.oauth2.userinfo.get().execute(function(resp) {
		    if (!resp.code) {
		      // User is signed in, so hide the button
		      document.getElementById('loginButton').style.visibility = 'hidden';
		      document.getElementById('login').innerText = 'Welcome ' + resp.name;
		    }
		    else {
		    	document.getElementById('loginButton').style.visibility = '';
		    }
		  });
		}
	    
	    function signin(mode, callback) {
	    	  gapi.auth.authorize({client_id: client_id,scope: scopes, immediate: mode},callback);
	    }
    
        function init() {
        	
        	var apisToLoad;
        	var callback = function() {
        	   if (--apisToLoad == 0) {
        	     signin(true, handleAuth);
        	     listCodes();
        	   }
        	}
        	  
        	apisToLoad = 2;
        	//Parameters are APIName,APIVersion,CallBack function,API Root 
        	//gapi.client.load('qdacity', 'v1', callback, 'https://localhost:8888/_ah/api');
        	gapi.client.load('qdacity', 'v1', callback, 'https://qdacity-app.appspot.com/_ah/api');
        	gapi.client.load('oauth2','v2',callback);
        	
        	                
                document.getElementById('btnListCode').onclick = function() {
                	listCodes();
                	//window.alert(codes);
                  }
                
                document.getElementById('addSubCode').onclick = function() {
                	addSubCode();
            	}
                
                document.getElementById('removeSubCode').onclick = function() {
                	removeSubCode();
            	}
                
                document.getElementById('deleteCode').onclick = function() {
                    deleteCode();
                }
                
                document.getElementById('loginButton').onclick = function() {
            		signin(false,handleAuth);
            	}
                
                
                
                
        }
        
        //List Codes function that will execute the listCode call
        function listCodes() {
        	var codes = [];
                gapi.client.qdacity.codes.listCode().execute(function(resp) {
                        if (!resp.code) {
                                resp.items = resp.items || [];
                                var result = "";
                                for (var i=0;i<resp.items.length;i++) {
                                        result = result+ resp.items[i].name + "..." + "<b>" + resp.items[i].author + "</b>" + "[" + resp.items[i].id + "]" + "   {" + resp.items[i].subCodesIDs + "}" + "<br/>";
                                        
                                        codes.push(resp.items[i]);
                                }
                                document.getElementById('listCodesResult').innerHTML = result;
                                for(var i=0;i<codes.length;i++) {
                                	addNodeToTree(codes[i].id, codes[i].name);
                                }
                                
                                for(var i=0;i<codes.length;i++) {
                                	if (typeof codes[i].subCodesIDs != 'undefined')
                                	{
	                                	if (codes[i].subCodesIDs.length > 0){
	                                		
		                                	for(var j=0;j<codes.length;j++) {
		                                		for(var k=0; k < codes[i].subCodesIDs.length; k++){
		                                			if (codes[i].subCodesIDs[k] == codes[j].id){
		                                				relocateNode(codes[j].id, codes[i].id);
		                                			}
		                                		}
		                                	}
		                                	
	                                    }
                                	}
                                }
                        }
                        
                });
        }
        
     
        
        

        //Insert Code function
        function insertCode(_AuthorName, _CodeName, _ID) {
                //Build the Request Object
                var requestData = {};
                requestData.author = _AuthorName;
                requestData.name = _CodeName;
                requestData.id = _ID;
                requestData.subCodesIDs = new Array();
                
                gapi.client.qdacity.codes.insertCode(requestData).execute(function(resp) {

                	console.log(resp.id + ":" + resp.author + ":" + resp.name);
                        if (!resp.code) {
                                //Just logging to console now, you can do your check here/display message
                                console.log(resp.id + ":" + resp.author + ":" + resp.name);
                                document.getElementById('listCodesResult').innerHTML = resp.id + ":" + resp.author + ":" + resp.name;
                                addNodeToTree(resp.id, resp.name);
                        }
                });
                
                
        }
        
        //Update Code function
        function updateCode(_AuthorName, _CodeName, _ID) {
                //Build the Request Object
                var requestData = {};
                requestData.id = _ID;
                requestData.author = _AuthorName;
                requestData.name = _CodeName;
                gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
                        if (!resp.code) {
                                //Just logging to console now, you can do your check here/display message
                                console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
                                changeNodeName(resp.id, resp.name);
                        }
                });
        }
        
        
        
        //Add SubCode function FIXME
        function addSubCode() {
            var _ID = document.getElementById("parentCodeID").value;
            var _SubID = document.getElementById("childCodeID").value;
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	          
            	          var code = {};
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            if (typeof resp.subCodesIDs == 'undefined'){
            	            	 requestData.subCodesIDs = [_SubID];
            	            }
            	            else {
            	            	requestData.subCodesIDs = resp.subCodesIDs.concat(_SubID);
            	            }
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    	relocateNode(_SubID, _ID);
            	                    }
            	            });
            	          
        	 });
    	}
        
        function removeSubCode() {
            //Validate the entries
            var _ID = document.getElementById("parentCodeID").value;
            var _SubID = document.getElementById("childCodeID").value;
            
            gapi.client.qdacity.codes.getCode({'id': _ID}).execute(function(resp) {
            	
            	          if (!resp.code) {
            	        	  console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	          }
            	          
            	          var code = {};
            	            
            	            var requestData = {};
            	           
                          	requestData.name = resp.name;
            	          	requestData.id = _ID;
            	            requestData.author = resp.author;
            	            for(var i = resp.subCodesIDs.length - 1; i >= 0; i--) {
            	            	
            	                if(resp.subCodesIDs[i] === _SubID) {
            	                	
            	                	resp.subCodesIDs.splice(i, 1);
            	                }
            	            }
            	            requestData.subCodesIDs = resp.subCodesIDs;
            	            gapi.client.qdacity.codes.updateCode(requestData).execute(function(resp) {
            	                    if (!resp.code) {
            	                            //Just logging to console now, you can do your check here/display message
            	                    	console.log(resp.id + ":" + resp.author + ":" + resp.name + ":" + resp.subCodesIDs);
            	                    }
            	            });
            	          
        	 });
    	}
        
        
        
        //Delete code function
        function deleteCode() {
                //Validate the entries
                var _ID = document.getElementById('codeID').value;
                
                //Build the Request Object
                var requestData = {};
                requestData.id = _ID;
                console.log(requestData);
                gapi.client.qdacity.codes.removeCode(requestData).execute(function(resp) {
                        //Just logging to console now, you can do your check here/display message
                        console.log(resp);
                        removeNodeFromTree(_ID);
                        
                });
                
        }
        
        
        $(function() {
        
            var dialog, form,
            name = $( "#newCodeName" ),
            email = $( "#newCodeAuthor" ),
            password = $( "#newCodeID" ),
            allFields = $( [] ).add( name ).add( email ).add( password ),
              tips = $( ".validateTips" );
         
         
            function addCode() {
            	var name = document.getElementById('newCodeName').value,
                author = document.getElementById('newCodeAuthor').value,
                id = document.getElementById("newCodeID" ).value;

              insertCode(author,name,id);
              dialog.dialog( "close" );
              form[ 0 ].reset();
            }
         
            dialog = $( "#new-code-form" ).dialog({
              autoOpen: false,
              height: 350,
              width: 450,
              modal: true,
              buttons: {
                "Add code": addCode,
                Cancel: function() {
                  dialog.dialog( "close" );
                }
              },
              close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
                
              }
            });
         
            form = dialog.find( "form" ).on( "submit", function( event ) {
              event.preventDefault();
              addCode();
            });
         
            $( "#btnInsertCode" ).on( "click", function() {
              dialog.dialog( "open" );
            });
            
          });
        
        $(function() {
            var dialog, form,
            name = $( "#updateCodeName" ),
            email = $( "#updateCodeAuthor" ),
            password = $( "#updateCodeID" ),
            allFields = $( [] ).add( name ).add( email ).add( password ),
              tips = $( ".validateTips" );
         
         
            function changeCode() {
            	var name = document.getElementById('updateCodeName').value,
                author = document.getElementById('updateCodeAuthor').value,
                id = document.getElementById("updateCodeID" ).value;

              updateCode(author,name,id);
              dialog.dialog( "close" );
              form[ 0 ].reset();
            }
         
            dialog = $( "#update-code-form" ).dialog({
              autoOpen: false,
              height: 350,
              width: 450,
              modal: true,
              buttons: {
                "Modify code": changeCode,
                Cancel: function() {
                  dialog.dialog( "close" );
                }
              },
              close: function() {
                form[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
                
              }
            });
         
            form = dialog.find( "form" ).on( "submit", function( event ) {
              event.preventDefault();
              changeCode();
            });
         
            $( "#btnUpdateCode" ).on( "click", function() {
              dialog.dialog( "open" );
            });
          });
        
        function addNodeToTree(id, name) {
            var sourceNode = {};
            sourceNode.text = name;
            sourceNode.isFolder = true;
            sourceNode.id = id;
           // var targetId = $('#lstNodes :selected').val();
           
           sourceNode.onclick = function() {
        	   window.alert("test");
           }
			
            easytree.addNode(sourceNode);
            easytree.rebuildTree();
            //loadSelectBox();
        }
        
        function removeNodeFromTree(id) {
            
            easytree.removeNode(id);
            easytree.rebuildTree();
        }
        
        function relocateNode(id, target) {
        	
            var sourceNode = easytree.getNode(id);
            sourceNode.isFolder = true;
            var targetId = target;
            easytree.removeNode(id);
			
            easytree.addNode(sourceNode, target);
            easytree.rebuildTree();
        }
        
		function changeNodeName(id, name) {
        	
            var sourceNode = easytree.getNode(id);
            sourceNode.text = name;

            easytree.rebuildTree();
        }

    </script>
    <script src="https://apis.google.com/js/client.js?onload=init"></script>
</body>
</html>
